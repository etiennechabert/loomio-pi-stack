# Loomio Production Configuration
# Copy this file to .env and fill in your secrets

# =============================================================================
# SECRETS CHECKLIST - Fill these in before starting:
# =============================================================================
# [ ] POSTGRES_PASSWORD - Database password
# [ ] SECRET_KEY_BASE - Rails secret key (openssl rand -hex 64)
# [ ] LOOMIO_HMAC_KEY - HMAC key (openssl rand -hex 32)
# [ ] DEVISE_SECRET - Devise secret (openssl rand -hex 32)
# [ ] BACKUP_ENCRYPTION_KEY - Backup encryption (openssl rand -hex 32)
# [ ] SECRET_COOKIE_TOKEN - Cookie token (openssl rand -hex 32)
# [ ] SMTP_PASSWORD - SMTP password for sending emails
# [ ] RAILS_INBOUND_EMAIL_PASSWORD - Inbound email password (openssl rand -hex 32)
# [ ] EMAIL_PROCESSOR_TOKEN - Email processor token (openssl rand -hex 32)
# [ ] GDRIVE_TOKEN - Google Drive OAuth token (rclone authorize)
# [ ] GDRIVE_FOLDER_ID - Google Drive folder ID
# [ ] CLOUDFLARE_TUNNEL_TOKEN - Cloudflare tunnel token
# [ ] TRANSLATE_CREDENTIALS - Google Translate service account JSON (optional)

# =============================================================================
# ENVIRONMENT
# =============================================================================
RAILS_ENV=production
RACK_ENV=production

# =============================================================================
# STORAGE MODE
# =============================================================================
# Enable RAM mode (tmpfs) for production
# Set to true for RAM-only operation (requires Google Drive backups)
# Set to false for disk-based operation
IS_RAM_MODE=true

# =============================================================================
# BASIC CONFIGURATION
# =============================================================================
# REQUIRED: Set to your actual domain
CANONICAL_HOST=loomio.lyckbo.de

SUPPORT_EMAIL=loomiolyckbo@gmail.com
HELPER_BOT_EMAIL=loomiolyckbo@gmail.com

# =============================================================================
# DATABASE
# =============================================================================
POSTGRES_DB=loomio_production
POSTGRES_USER=loomio

# =============================================================================
# SECRET KEYS
# =============================================================================
# REQUIRED: Generate with: openssl rand -base64 32
POSTGRES_PASSWORD=<your-secure-password>

# REQUIRED: Generate with: openssl rand -hex 64
SECRET_KEY_BASE=<generate-with-openssl-rand-hex-64>

# REQUIRED: Generate with: openssl rand -hex 32
LOOMIO_HMAC_KEY=<generate-with-openssl-rand-hex-32>

# REQUIRED: Generate with: openssl rand -hex 32
DEVISE_SECRET=<generate-with-openssl-rand-hex-32>

# REQUIRED: Generate with: openssl rand -hex 32
BACKUP_ENCRYPTION_KEY=<generate-with-openssl-rand-hex-32>

# REQUIRED: Generate with: openssl rand -hex 32
SECRET_COOKIE_TOKEN=<generate-with-openssl-rand-hex-32>

# =============================================================================
# EMAIL / SMTP CONFIGURATION
# =============================================================================
# REQUIRED: Configure your SMTP server
SMTP_DOMAIN=gmail.com
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=loomiolyckbo@gmail.com
SMTP_PASSWORD=<your-smtp-password>
SMTP_AUTH=plain
SMTP_USE_TLS=true

REPLY_HOSTNAME=loomio.lyckbo.de
FROM_EMAIL=loomiolyckbo@gmail.com

# =============================================================================
# PORTS
# =============================================================================
LOOMIO_PORT=3000
CHANNELS_PORT=5000
HOCUSPOCUS_PORT=4000
ADMINER_PORT=8081
NETDATA_PORT=19999

# =============================================================================
# WEBSOCKET URLS (HTTPS/WSS for production)
# =============================================================================
# Set these to match your production domain
CHANNELS_URL=https://loomio.lyckbo.de/cable
HOCUSPOCUS_URL=https://loomio.lyckbo.de/hocuspocus

# =============================================================================
# SSL (Enabled for production)
# =============================================================================
FORCE_SSL=true

# =============================================================================
# INCOMING EMAIL (Reply-by-Email)
# =============================================================================
# Token to authenticate incoming email webhook requests
# Generate with: openssl rand -hex 32
RAILS_INBOUND_EMAIL_PASSWORD=<generate-with-openssl-rand-hex-32>
EMAIL_PROCESSOR_TOKEN=<generate-with-openssl-rand-hex-32>

# =============================================================================
# BACKUP CONFIGURATION
# =============================================================================

BACKUP_SCHEDULE="0 3 * * *"
BACKUP_RETENTION_DAYS=30

# Google Drive Integration (REQUIRED for production backups)
# IMPORTANT: Google Drive is MANDATORY for RAM mode to backup both database AND files
GDRIVE_ENABLED=true
# Generate with: docker compose exec backup rclone authorize "drive"
GDRIVE_TOKEN=<your-gdrive-oauth-token>
# Folder ID where backups/files will be synced
GDRIVE_FOLDER_ID=<your-gdrive-folder-id>

# Google Translate API Credentials (Optional - for automatic translations)
# Service account JSON from Google Cloud Console
TRANSLATE_CREDENTIALS=<your-service-account-json>


# =============================================================================
# PRODUCTION MODE = RAM MODE
# =============================================================================
# Production automatically uses RAM mode to minimize SD card writes:
#   - Database → tmpfs (RAM)
#   - Redis → tmpfs (RAM)
#   - Backups → tmpfs (RAM) → Google Drive
#   - On boot: Google Drive → tmpfs (RAM) → Database
#   - ZERO SD card writes!
#
# CRITICAL: Google Drive is MANDATORY for RAM mode (no disk persistence)
#
# Requirements:
#   ✓ 8GB+ RAM (16GB recommended for production)
#   ✓ Google Drive configured above (GDRIVE_ENABLED=true)
#   ✓ Hourly backups (BACKUP_SCHEDULE="0 * * * *" recommended)

# =============================================================================
# MONITORING (Netdata Cloud - Optional)
# =============================================================================
NETDATA_CLAIM_TOKEN=
NETDATA_CLAIM_ROOMS=

# =============================================================================
# AUTO-UPDATE (Watchtower)
# =============================================================================
WATCHTOWER_SCHEDULE="0 15 3 * * *"
WATCHTOWER_NOTIFICATIONS=
WATCHTOWER_NOTIFICATION_URL=

# =============================================================================
# CLOUDFLARE TUNNEL (Optional)
# =============================================================================
CLOUDFLARE_TUNNEL_TOKEN=<your-production-tunnel-token>

# =============================================================================
# FILE STORAGE (Optional - S3)
# =============================================================================
# AWS_ACCESS_KEY_ID=
# AWS_SECRET_ACCESS_KEY=
# AWS_REGION=us-east-1
# AWS_BUCKET=


# =============================================================================
# FILE UPLOAD LIMITS
# =============================================================================
# Maximum file upload size in MB
MAX_ATTACHMENT_SIZE_MB=42

# =============================================================================
# PERFORMANCE TUNING
# =============================================================================
# Optimized for Raspberry Pi 5 (4 cores, 4-8GB RAM)
PUMA_WORKERS=2
RAILS_MAX_THREADS=5
SIDEKIQ_CONCURRENCY=5
MAX_THREADS=4

# =============================================================================
# MONITORING ALERTS
# =============================================================================
# IMPORTANT: Email address to receive critical system alerts
# Netdata will send alerts for:
#   - RAM usage > 80% (warning) or > 90% (critical)
#   - CPU usage > 80% (warning) or > 95% (critical)
#   - Low available RAM < 1GB (warning) or < 500MB (critical)
#   - High system load
ALERT_EMAIL=etienne.chabert@gmail.com

# =============================================================================
# PRODUCTION SETTINGS
# =============================================================================
RAILS_LOG_LEVEL=info
DEBUG=false

# HTTP Logging & Metrics
# Enable detailed request logging with timing information
RAILS_LOG_TO_STDOUT=true
LOGRAGE_ENABLED=true
LOGRAGE_FORMAT=json

# Disable public threads for private community (users must log in to view content)
FEATURES_DISABLE_PUBLIC_THREADS=true

# =============================================================================
# RATE LIMITING (Rack Attack)
# =============================================================================
RACK_ATTACK_RATE_MULTPLIER=100
RACK_ATTACK_TIME_MULTPLIER=1

# =============================================================================
# FEATURE FLAGS
# =============================================================================
FEATURES_DISABLE_CREATE_USER=1     # users must be invited
FEATURES_DISABLE_CREATE_GROUP=1    # users cannot create groups
FEATURES_DISABLE_PUBLIC_GROUPS=1   # disable /explore
# FEATURES_DISABLE_HELP_LINK=1       # disable the help link
FEATURES_DEFAULT_PATH=/lyckbo    # rather than redirecting to dashboard, redirect to this path


# Email for system alerts and daily error reports
# Used for Netdata alerts and daily error digest from application logs
ALERT_EMAIL=etienne.chabert@gmail.com
