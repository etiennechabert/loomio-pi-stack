name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Validate docker-compose.yml
      run: docker compose config

    - name: Check for required files
      run: |
        test -f .env.example || exit 1
        test -f docker-compose.yml || exit 1
        test -f README.md || exit 1

    - name: Validate .env.example
      run: |
        grep -q "POSTGRES_PASSWORD=" .env.example
        grep -q "SECRET_KEY_BASE=" .env.example
        grep -q "SMTP_SERVER=" .env.example

    - name: Check script permissions
      run: |
        find scripts -type f -name "*.sh" -exec test -x {} \; -o -exec echo "{} is not executable" \;

    - name: Build backup service
      run: docker compose build backup

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Check for secrets
      run: |
        if git grep -E "(password|secret|token|key).*=.*[a-zA-Z0-9]{20,}" -- ':!.env.example' ':!*.md'; then
          echo "Potential secrets found in tracked files!"
          exit 1
        fi
