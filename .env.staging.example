# Loomio Staging Configuration
# Copy this file to .env and fill in your secrets
# Staging mirrors production but uses separate Google Drive folder and tunnel

# =============================================================================
# SECRETS CHECKLIST - Fill these in before starting:
# =============================================================================
# [ ] POSTGRES_PASSWORD - Database password
# [ ] SECRET_KEY_BASE - Rails secret key (openssl rand -hex 64)
# [ ] LOOMIO_HMAC_KEY - HMAC key (openssl rand -hex 32)
# [ ] DEVISE_SECRET - Devise secret (openssl rand -hex 32)
# [ ] BACKUP_ENCRYPTION_KEY - Backup encryption (openssl rand -hex 32)
# [ ] SECRET_COOKIE_TOKEN - Cookie token (openssl rand -hex 32)
# [ ] SMTP_PASSWORD - SMTP password for sending emails
# [ ] RAILS_INBOUND_EMAIL_PASSWORD - Inbound email password (openssl rand -hex 32)
# [ ] EMAIL_PROCESSOR_TOKEN - Email processor token (openssl rand -hex 32)
# [ ] GDRIVE_TOKEN - Google Drive OAuth token (rclone authorize)
# [ ] GDRIVE_FOLDER_ID - Google Drive folder ID
# [ ] CLOUDFLARE_TUNNEL_TOKEN - Cloudflare tunnel token
# [ ] TRANSLATE_CREDENTIALS - Google Translate service account JSON (optional)

# =============================================================================
# ENVIRONMENT
# =============================================================================
RAILS_ENV=staging
RACK_ENV=staging

# =============================================================================
# STORAGE MODE
# =============================================================================
# Enable RAM mode (tmpfs) for staging - identical to production
# Set to true for RAM-only operation (requires Google Drive backups)
# Set to false for disk-based operation
IS_RAM_MODE=true

# =============================================================================
# BASIC CONFIGURATION
# =============================================================================
# Staging domain
CANONICAL_HOST=staging-loomio.lyckbo.de

SUPPORT_EMAIL=loomiolyckbo@gmail.com
HELPER_BOT_EMAIL=loomiolyckbo@gmail.com

# =============================================================================
# DATABASE
# =============================================================================
# Different database name to prevent confusion with production
POSTGRES_DB=loomio_staging
POSTGRES_USER=loomio

# =============================================================================
# SECRET KEYS
# =============================================================================
# REQUIRED: Use SAME secrets as production for feature parity
POSTGRES_PASSWORD=<copy-from-production-or-use-different>

# REQUIRED: Use SAME as production
SECRET_KEY_BASE=<copy-from-production>

# REQUIRED: Use SAME as production
LOOMIO_HMAC_KEY=<copy-from-production>

# REQUIRED: Use SAME as production
DEVISE_SECRET=<copy-from-production>

# REQUIRED: Use SAME as production (staging backups must use same encryption)
BACKUP_ENCRYPTION_KEY=<copy-from-production>

# REQUIRED: Use SAME as production
SECRET_COOKIE_TOKEN=<copy-from-production>

# =============================================================================
# EMAIL / SMTP CONFIGURATION
# =============================================================================
# Can use same SMTP as production or different test account
SMTP_DOMAIN=gmail.com
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=loomiolyckbo@gmail.com
SMTP_PASSWORD=<copy-from-production-or-use-test-account>
SMTP_AUTH=plain
SMTP_USE_TLS=true

REPLY_HOSTNAME=staging-loomio.lyckbo.de
FROM_EMAIL=loomiolyckbo@gmail.com

# =============================================================================
# PORTS
# =============================================================================
LOOMIO_PORT=3000
CHANNELS_PORT=5000
HOCUSPOCUS_PORT=4000
ADMINER_PORT=8081
NETDATA_PORT=19999

# =============================================================================
# WEBSOCKET URLS (HTTPS/WSS for staging)
# =============================================================================
# Staging domain URLs
CHANNELS_URL=wss://staging-loomio.lyckbo.de/cable
HOCUSPOCUS_URL=wss://staging-loomio.lyckbo.de/hocuspocus

# =============================================================================
# SSL (Enabled for staging via Cloudflare)
# =============================================================================
FORCE_SSL=true

# =============================================================================
# INCOMING EMAIL (Reply-by-Email)
# =============================================================================
# Use SAME tokens as production for testing
RAILS_INBOUND_EMAIL_PASSWORD=<copy-from-production>
EMAIL_PROCESSOR_TOKEN=<copy-from-production>

# =============================================================================
# BACKUP CONFIGURATION
# =============================================================================

BACKUP_SCHEDULE="0 3 * * *"
BACKUP_RETENTION_DAYS=30

# Google Drive Integration (REQUIRED for RAM mode backups)
# IMPORTANT: Use SAME Google Drive credentials as production
# RAILS_ENV=staging automatically creates staging/ subdirectory
GDRIVE_ENABLED=true
# Use SAME token as production
GDRIVE_TOKEN=<copy-from-production>
# Use SAME folder ID as production (staging/ subfolder created automatically)
GDRIVE_FOLDER_ID=<copy-from-production>

# Google Translate API Credentials (Optional - use same as production)
TRANSLATE_CREDENTIALS=<copy-from-production>


# =============================================================================
# STAGING MODE = RAM MODE
# =============================================================================
# Staging uses RAM mode identical to production:
#   - Database → tmpfs (RAM)
#   - Redis → tmpfs (RAM)
#   - Backups → tmpfs (RAM) → Google Drive (staging/ folder)
#   - On boot: Google Drive (staging/) → tmpfs (RAM) → Database
#   - ZERO SD card writes!
#
# CRITICAL: Google Drive is MANDATORY for RAM mode (no disk persistence)
#
# Staging folder structure in Google Drive:
#   lyckbo-loomio/
#   ├── production/backups/  ← Production backups
#   └── staging/backups/     ← Staging backups (separate)

# =============================================================================
# MONITORING (Netdata Cloud - Optional)
# =============================================================================
NETDATA_CLAIM_TOKEN=
NETDATA_CLAIM_ROOMS=

# =============================================================================
# AUTO-UPDATE (Watchtower)
# =============================================================================
WATCHTOWER_SCHEDULE="0 15 3 * * *"
WATCHTOWER_NOTIFICATIONS=
WATCHTOWER_NOTIFICATION_URL=

# =============================================================================
# CLOUDFLARE TUNNEL (REQUIRED for staging)
# =============================================================================
# DIFFERENT tunnel token than production (for staging-loomio.lyckbo.de)
CLOUDFLARE_TUNNEL_TOKEN=<your-staging-tunnel-token>

# =============================================================================
# FILE STORAGE (Optional - S3)
# =============================================================================
# AWS_ACCESS_KEY_ID=
# AWS_SECRET_ACCESS_KEY=
# AWS_REGION=us-east-1
# AWS_BUCKET=


# =============================================================================
# FILE UPLOAD LIMITS
# =============================================================================
# Maximum file upload size in MB
MAX_ATTACHMENT_SIZE_MB=42

# =============================================================================
# PERFORMANCE TUNING
# =============================================================================
# Optimized for Raspberry Pi 5 (4 cores, 4-8GB RAM) - same as production
PUMA_WORKERS=2
RAILS_MAX_THREADS=5
SIDEKIQ_CONCURRENCY=5
MAX_THREADS=4

# =============================================================================
# MONITORING ALERTS
# =============================================================================
# Email address to receive staging alerts
ALERT_EMAIL=etienne.chabert@gmail.com

# =============================================================================
# STAGING SETTINGS
# =============================================================================
RAILS_LOG_LEVEL=info
DEBUG=false

# HTTP Logging & Metrics
RAILS_LOG_TO_STDOUT=true
LOGRAGE_ENABLED=true
LOGRAGE_FORMAT=json

# Disable public threads (same as production)
FEATURES_DISABLE_PUBLIC_THREADS=true

# =============================================================================
# RATE LIMITING (Rack Attack)
# =============================================================================
RACK_ATTACK_RATE_MULTPLIER=100
RACK_ATTACK_TIME_MULTPLIER=1

# =============================================================================
# FEATURE FLAGS
# =============================================================================
# Same feature flags as production for testing parity
FEATURES_DISABLE_CREATE_USER=1     # users must be invited
FEATURES_DISABLE_CREATE_GROUP=1    # users cannot create groups
FEATURES_DISABLE_PUBLIC_GROUPS=1   # disable /explore
# FEATURES_DISABLE_HELP_LINK=1       # disable the help link
FEATURES_DEFAULT_PATH=/lyckbo    # rather than redirecting to dashboard, redirect to this path


# Email for system alerts and daily error reports
ALERT_EMAIL=etienne.chabert@gmail.com
