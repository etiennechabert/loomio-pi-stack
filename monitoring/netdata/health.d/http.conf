# HTTP Metrics Health Monitoring
# Monitors Rails application HTTP traffic, response times, and error rates
# Uses hourly aggregates for 5xx rate and response time to reduce noise

# 5xx Server Error Rate (Hourly) - Warning
alarm: loomio_http_5xx_errors_hourly_warning
   on: rails_http.error_rate_hourly
 lookup: average -5m unaligned of rate
  units: %
  every: 30s
   warn: $this > 50
  delay: up 3m down 15m multiplier 1.5 max 1h
   info: HTTP 5xx error rate over 1 hour is elevated (>0.5% of requests)
     to: sysadmin

# 5xx Server Error Rate (Hourly) - Critical
alarm: loomio_http_5xx_errors_hourly_critical
   on: rails_http.error_rate_hourly
 lookup: average -5m unaligned of rate
  units: %
  every: 30s
   crit: $this > 200
  delay: up 2m down 15m multiplier 1.5 max 1h
   info: HTTP 5xx error rate over 1 hour is critical (>2% of requests)
     to: sysadmin

# p90 Response Time (Hourly) - Warning
alarm: loomio_http_response_time_p90_hourly_warning
   on: rails_http.response_time_hourly
 lookup: average -5m unaligned of p90
  units: ms
  every: 30s
   warn: $this > 2000
  delay: up 5m down 20m multiplier 1.5 max 1h
   info: HTTP p90 response time over 1 hour is slow (>2 seconds)
     to: sysadmin

# p90 Response Time (Hourly) - Critical
alarm: loomio_http_response_time_p90_hourly_critical
   on: rails_http.response_time_hourly
 lookup: average -5m unaligned of p90
  units: ms
  every: 30s
   crit: $this > 5000
  delay: up 3m down 20m multiplier 1.5 max 1h
   info: HTTP p90 response time over 1 hour is very slow (>5 seconds)
     to: sysadmin

# p50 Response Time (Hourly) - Critical at 2s
alarm: loomio_http_response_time_p50_hourly_critical
   on: rails_http.response_time_hourly
 lookup: average -5m unaligned of p50
  units: ms
  every: 30s
   crit: $this > 2000
  delay: up 5m down 20m multiplier 1.5 max 1h
   info: HTTP p50 (median) response time over 1 hour is above 2 seconds - majority of requests are slow
     to: sysadmin

# Peak Response Time - Critical (for immediate spikes)
alarm: loomio_http_response_time_peak
   on: rails_http.response_time
 lookup: max -1m unaligned of max
  units: ms
  every: 30s
   warn: $this > 10000
  delay: up 2m down 10m multiplier 1.5 max 1h
   info: HTTP peak response time is very high (>10 seconds) - check for slow queries or timeouts
     to: sysadmin

# No HTTP Traffic (application might be stuck)
alarm: loomio_http_no_traffic
   on: rails_http.requests
 lookup: sum -5m unaligned of total
  units: requests
  every: 1m
   warn: $this == 0
  delay: up 5m down 5m multiplier 1.5 max 1h
   info: No HTTP requests in the last 5 minutes - application may be unresponsive
     to: sysadmin
