# Loomio Stack Health Monitoring
# Custom health checks for Netdata

# PostgreSQL Database Health
alarm: loomio_db_down
   on: docker.container_running
 lookup: average -1m unaligned of loomio-db
  units: running
  every: 10s
   crit: $this == 0
  delay: down 1m multiplier 1.5 max 1h
   info: Loomio database container is not running
     to: sysadmin

# Loomio App Health
alarm: loomio_app_down
   on: docker.container_running
 lookup: average -1m unaligned of loomio-app
  units: running
  every: 10s
   crit: $this == 0
  delay: down 1m multiplier 1.5 max 1h
   info: Loomio app container is not running
     to: sysadmin

# Loomio Worker Health
alarm: loomio_worker_down
   on: docker.container_running
 lookup: average -1m unaligned of loomio-worker
  units: running
  every: 10s
   crit: $this == 0
  delay: down 1m multiplier 1.5 max 1h
   info: Loomio worker container is not running
     to: sysadmin

# Loomio Channels Health
alarm: loomio_channels_down
   on: docker.container_running
 lookup: average -1m unaligned of loomio-channels
  units: running
  every: 10s
   crit: $this == 0
  delay: down 1m multiplier 1.5 max 1h
   info: Loomio channels container is not running
     to: sysadmin

# Loomio Hocuspocus Health
alarm: loomio_hocuspocus_down
   on: docker.container_running
 lookup: average -1m unaligned of loomio-hocuspocus
  units: running
  every: 10s
   crit: $this == 0
  delay: down 1m multiplier 1.5 max 1h
   info: Loomio hocuspocus container is not running
     to: sysadmin

# Redis Health
alarm: loomio_redis_down
   on: docker.container_running
 lookup: average -1m unaligned of loomio-redis
  units: running
  every: 10s
   crit: $this == 0
  delay: down 1m multiplier 1.5 max 1h
   info: Loomio Redis container is not running
     to: sysadmin

# Backup Service Health
alarm: loomio_backup_down
   on: docker.container_running
 lookup: average -1m unaligned of loomio-backup
  units: running
  every: 10s
   crit: $this == 0
  delay: down 1m multiplier 1.5 max 1h
   info: Loomio backup container is not running
     to: sysadmin

# Disk Space Warning
alarm: loomio_disk_space_warning
   on: disk.space
 lookup: average -1m percentage of used
  units: %
  every: 1m
   warn: $this > 80
   crit: $this > 90
  delay: down 15m multiplier 1.5 max 1h
   info: Disk space usage is high
     to: sysadmin

# Memory Usage Warning
alarm: loomio_memory_warning
   on: system.ram
 lookup: average -1m percentage of used
  units: %
  every: 1m
   warn: $this > 80
   crit: $this > 90
  delay: down 15m multiplier 1.5 max 1h
   info: Memory usage is high
     to: sysadmin
